function getContacts(){var a={action:"get_contacts"};return JSON.stringify(a)}function getConversations(){var a={action:"get_conversations"};return JSON.stringify(a)}function getMessagesJSON(c,b,e,d){if(c==null){return false}var a={action:"get_messages",thread_id:c,amount:b,offset:e,period:d};return JSON.stringify(a)}function prepareMessages(a,d,b,e){var c={action:"send_messages",body:a,data:d,temp_message_id:e,numbers:b};return JSON.stringify(c)}var CONTACTS="contacts";var CONVERSATIONS="conversations";var MESSAGES="messages";var RECIPIENTS="recipients";var SCROLL_TOP="scroll_top";var FULL_NAME="full_name";var PHONE_NUMBER="phone_number";var TEMP_MESSAGE_ID="temp_message_id";var TEMP_CONVO_ID="temp_convo_id";var MESSAGE_ID="message_id";var MESSAGE="message";var DATE="date";var CONVO_ID="convo_id";var NUMBER="number";var KEY="key";var temp_convo_id_count=0;var TRUE="true";var messageTempIdArr=[];var convoTempIdArr=[];function storeContacts(a){var b=sessionStorage.getItem(CONTACTS);var d=a[CONTACTS];if(b==null){var c=d.sort(function(f,e){var g=0;if(f[Object.keys(f)[0]][FULL_NAME]>e[Object.keys(e)[0]][FULL_NAME]){g=1}else{if(f[Object.keys(f)[0]][FULL_NAME]<e[Object.keys(e)[0]][FULL_NAME]){g=-1}}return g});sessionStorage.setItem(CONTACTS,JSON.stringify(c))}else{b=JSON.parse(b);var c=d.sort(function(f,e){var g=0;if(f[Object.keys(f)[0]][FULL_NAME]>e[Object.keys(e)[0]][FULL_NAME]){g=1}else{if(f[Object.keys(f)[0]][FULL_NAME]<e[Object.keys(e)[0]][FULL_NAME]){g=-1}}return g});c=c.filter(function(f,g,e){return !g||Object.keys(f)[0]!=Object.keys(e[g-1])[0]});sessionStorage.setItem(CONTACTS,JSON.stringify(c))}}function retrieveContacts(){var a=sessionStorage.getItem(CONTACTS);if(a==null){a={}}else{a=JSON.parse(a)}return a}function retrieveContact(e){var d=JSON.parse(sessionStorage.getItem(CONTACTS));for(var b=0;b<d.length;b++){var c=d[b];var a=Object.keys(c)[0];if(a==e){return c[a]}}return null}function retrieveContactName(b){var a=JSON.parse(sessionStorage.getItem(CONTACTS));$.each(a,function(c,e){var d=Object.keys(e)[0];if(d==b){return e[d][FULL_NAME]}});return"UNKNOWN"}function storeConversations(g){var e=g[CONVERSATIONS];var h=sessionStorage.getItem(CONVERSATIONS);if(h==null){h={}}else{var b={};h=JSON.parse(h);$.each(h,function(i,l){var m=Object.keys(l)[0];b[m]=l[m]});h=b}for(var d in e){var j=Object.keys(e[d])[0];h[j]=e[d][j]}const f=[];var k=Object.keys(h);k=k.sort(function(l,i){return parseInt(h[i][DATE])-parseInt(h[l][DATE])});for(var d in k){var c={};var a=k[d];c[a]=h[a];f.push(c)}sessionStorage.setItem(CONVERSATIONS,JSON.stringify(f))}function retrieveConversations(){var a=sessionStorage.getItem(CONVERSATIONS);if(a==null){a={}}else{a=JSON.parse(a)}return a}function retrieveConversation(c){var b=JSON.parse(sessionStorage.getItem(CONVERSATIONS));var a=null;$.each(b,function(d,f){var e=Object.keys(f)[0];if(e==c){a=f[c]}});return a}function storeMessages(d){var b=d[THREAD_ID];var c=MESSAGES+b;var f=sessionStorage.getItem(c);if(f==null){sessionStorage.setItem(c,JSON.stringify(d[b].sort(function(h,g){return h[Object.keys(h)[0]][DATE_RECIEVED]-g[Object.keys(g)[0]][DATE_RECIEVED]})))}else{var a=d[b];f=JSON.parse(f);var e=a.concat(f).sort(function(h,g){return h[Object.keys(h)[0]][DATE_RECIEVED]-g[Object.keys(g)[0]][DATE_RECIEVED]});e=e.filter(function(h,i,g){return !i||Object.keys(h)[0]!=Object.keys(g[i-1])[0]});sessionStorage.setItem(c,JSON.stringify(e))}return true}function retrieveMessages(a){return JSON.parse(sessionStorage.getItem(MESSAGES+a))}function getNumbers(e){var b=[];var a=retrieveConversation(e)[RECIPIENTS];for(var c in a){var d={number:a[c][PHONE_NUMBER]};b.push(d)}return b}function storeMessageTempIdArr(d,c,a){var b=messageTempIdArr;if(b==null){b=[]}b.push(JSON.stringify({temp_message_id:d,convo_id:c,body:a}))}function retrieveMessageTempIdArr(){return messageTempIdArr}function storeConvoTempId(a){convoTempIdArr.push(a)}function retrieveConvoTempIdArr(){return convoTempIdArr}function storeScrollTop(b,a){sessionStorage.setItem(SCROLL_TOP+b,a)}function retrieveScrollTop(a){return sessionStorage.getItem(SCROLL_TOP+a)}function prepareGetData(d,c,a){var b={action:"get_data",message_id:a,part_id:d,content_type:c};return JSON.stringify(b)}function retrieveDataLoad(a){return sessionStorage.getItem(DATA+a+DATA)}var DEFAULT_GET_MESSAGES=15;var DEFAULT_GET_MESSAGES_AFTER=20;var BODY="body";var MESSAGE_TYPE="message_type";var THREAD_ID="thread_id";var ID="ID";var TYPE="type";var MMS="mms";var TYPE_INBOX=1;var TYPE_SENT=2;var PARTS="parts";var _DATA="_data";var DATE_RECIEVED="date_recieved";var CONTACT_ID="contact_id";var ADDRESS="address";var PART_ID="part_id";var DATALOAD="DATALOAD";var TEXT="TEXT";var CONTENT_TYPE="CONTENT_TYPE";var CONTENT_TYPE_TEXT_PLAIN="text/plain";var CONTENT_TYPE_IMAGE="image";var TYPE_LOCAL_SEND=20;var CLASS_POINTER="pointer";var CLASS_POINTER_NEW_MESSAGE="new_message_pointer";var MESSAGE_COUNT="message_count";var MESSAGE_BACKGROUND_COLOR_ME_SENT="#C77FFF";var MESSAGE_BACKGROUND_COLOR_RECEIVED="#52CC82";var MESSAGE_BACKGROUND_COLOR_WAITING="#FF7FE5";var MESSAGE_TEXT_COLOR="white";var CONVO_BACKGROUND_COLOR="#FFFFFF";var CONVO_BACKGROUND_COLOR_SELECTED="#B697FA";var CONVO_BACKGROUND_COLOR_MESSAGE_RECEIVED="#8EE6B7";var CONVO_BACKGROUND_MESSAGE_COUNT="#8347B2";var CONVO="convo";var CONTACT_BACKGROUND_COLOR="#FFFFFF";var CONTACT_BACKGROUND_COLOR_SELETED="#FF7FE5";var CLASS_SELECTED_CONTACT="selected_contact";var CLASS_REMOVE_SHIFT_SELECT="remove_shift_select";var CLASS_RECIPIENTS="new_message_recipients";var RECIPIENT_LIST="RECIPIENT_LIST";var sendingNewMessage=false;function uiAddAllConversations(){$("slt_conversation").empty();var c=retrieveConversations();var a=Object.keys(c);var b=$("#slt_conversation");$.each(c,function(g,i){var l=Object.keys(i)[0];var k=i[l][RECIPIENTS];var m=k.length;var f=[];for(var e in k){if(k[e][FULL_NAME]!=null){f.push(k[e][FULL_NAME]+" "+getPhoneNumberFormat(k[e][PHONE_NUMBER]))}else{f.push(getPhoneNumberFormat(k[e][PHONE_NUMBER]))}}var j=$("#"+CONVERSATIONS+l);if(j.length==0){var d=createConversationDiv(f,l,i[l][MESSAGE_COUNT]);var n=$("#convo_id").val();if(n==l){d.css("background-color",CONVO_BACKGROUND_COLOR_SELECTED)}d.on("click",function(){var q=$("#convo_id");var o=q.val();var p=$(this);var r=getNumbersFromString(p.attr("id"));if(r!=o){if(r!=o){$("#"+CONVERSATIONS+o).css("background-color","");storeScrollTop(o,getRMAdjustedScrollTop())}q.attr("value",r);if(!uiAddConversationMessages(r)){webSocketCon.send(getMessagesJSON(r,DEFAULT_GET_MESSAGES,-1,0))}else{$("#"+CONVO+o).hide()}setTimeout(function(){uiScrollTop(retrieveScrollTop(r))},300)}p.css("background-color",CONVO_BACKGROUND_COLOR_SELECTED)});b.append(d)}else{var h=j.children("span")[0];h.innerText=h.textContent=i[l][MESSAGE_COUNT];b.append(j)}})}function uiAddAllContacts(){var e=$("#slt_contact");var d=retrieveContacts();for(var c in d){var b=Object.keys(d[c])[0];var a=$("#"+CONTACTS+b);if(a.length==0){a=createContactDiv(d[c][b][FULL_NAME],b,getPhoneNumberFormat(d[c][b][PHONE_NUMBER]))}e.append(a)}}function uiAddConversationMessages(d){var b=retrieveMessages(d);if(b!==null){var c=$("#rm_messageArea");var a=retrieveMessageTempIdArr().slice();var e=$("#"+CONVO+d).show();if(e.length==0){e=$('<div id="'+CONVO+d+'">').show();c.append(e)}$.each(b,function(h,l){var k=Object.keys(l)[0];var g=$("#"+MESSAGES+k);if(g.length==0){uiAppendMessage(l[k],k,e,d)}else{e.append(g)}var m=retrieveMessageTempIdArr();for(var j in m){var f=JSON.parse(m[j]);if(f[TEMP_MESSAGE_ID]==k){uiAppendMessage(f[TEMP_MESSAGE_ID],k,e,d)}}})}else{return false}return true}function uiPrependMessage(e,c,a){var f=convoDivExists(e);var d=$("#rm_messageArea");var b=-1;if(f==null){f=$('<div id="'+CONVO+a+'">');$("#rm_messageArea").append(f)}else{b=d.scrollTop()-d.offset().top}$.each(c,function(g,h){$.each(h,function(i,j){if($("#"+MESSAGES+i).length==0){f.prepend(createMessageDiv(j,i,a))}})});if(b>=0){b+=(d.offset().top*2)}uiScrollTop(b)}function uiAppendMessage(b,e,d,a){var c=createMessageDiv(b,e,a);d.append(c)}function createMessageDiv(f,a,k){var c,h,b=false,j=(f[TYPE]==MMS),d=retrieveConversation(k)[RECIPIENTS].length>1;if(j){c=getTextFromParts(f[PARTS]);b=hasDataFromParts(f[PARTS]);h=f[MESSAGE_TYPE]}else{c=f[BODY];h=f[MESSAGE_TYPE]}var g;var e;var i;if(h==TYPE_INBOX){g=$("<div>").css({margin:"4px 6px",width:"100%","float":"right"});if(b){i=$("<div>");$.each(f[PARTS],function(m,o){if(o[CONTENT_TYPE]!="text/plain"){var n=$("<span>").html("Click me to load image!").addClass("data").css({"float":"left",display:"block",clear:"left"}).attr("id",DATA+o.id).attr("val",o[CONTENT_TYPE]);n.on("click",function(){if(!retrieveDataLoad($(this).attr("id"))){var r=getNumbersFromString($(this).attr("id"));var q=$(this).attr("val");var p=getNumbersFromString($(this).parent().parent().attr("id"));webSocketCon.send(prepareGetData(r,q,p));$(this).html("  Loading...");$(this).prepend($("<span>").addClass("glyphicon glyphicon-refresh spinning"));$(this).attr("id",DATALOAD+r)}});i.append(n)}})}if((j&&c!="")||!j){e=$("<span>").html(c).css({"float":"left",padding:"6px 12px","background-color":MESSAGE_BACKGROUND_COLOR_RECEIVED,"border-radius":"20px","max-width":"45%","word-wrap":"break-word",color:MESSAGE_TEXT_COLOR,display:"inline-block","word-break":"break-word",clear:"left","font-size":"16px"})}if(d){if(e!=undefined){e.html(e.html()+"<br>");var l=$("<span>").html(matchAddressFromConvo(k,f[ADDRESS])).css({"word-wrap":"break-word",display:"inline-block","word-break":"break-word","font-size":"13px"});e.append(l)}}g.attr("id",MESSAGES+a)}else{if(h==TYPE_SENT){g=$("<div>").css({margin:"4px 6px",width:"100%","float":"left"});if(b){i=$("<div>");$.each(f[PARTS],function(m,o){if(o[CONTENT_TYPE]!="text/plain"){var n=$("<span>").html("Click me to load image!").addClass("data").css({"float":"right",display:"block",clear:"right"}).attr("id",DATA+o.id).attr("val",o[CONTENT_TYPE]);n.on("click",function(){if(!retrieveDataLoad($(this).attr("id"))){var r=getNumbersFromString($(this).attr("id"));var q=$(this).attr("val");var p=getNumbersFromString($(this).parent().parent().attr("id"));webSocketCon.send(prepareGetData(r,q,p));$(this).html("  Loading...");$(this).prepend($("<span>").addClass("glyphicon glyphicon-refresh spinning"));$(this).attr("id",DATALOAD+r)}});i.append(n)}})}if((j&&c!="")||!j){e=$("<span>").html(c).css({"float":"right",padding:"6px 12px","background-color":MESSAGE_BACKGROUND_COLOR_ME_SENT,"border-radius":"20px","max-width":"45%","word-wrap":"break-word",color:MESSAGE_TEXT_COLOR,display:"inline-block","word-break":"break-word",clear:"right","font-size":"16px"})}g.attr("id",MESSAGES+a)}else{if(h==TYPE_LOCAL_SEND){e=$("<span>").html(c).css({"float":"right",padding:"6px 12px","background-color":MESSAGE_BACKGROUND_COLOR_WAITING,"border-radius":"20px","max-width":"45%","word-wrap":"break-word",display:"inline-block","word-break":"break-word",color:MESSAGE_TEXT_COLOR,"font-size":"16px"});g=$("<div>").css({margin:"4px 6px",width:"100%","float":"left"});g.attr("id",TEMP_MESSAGE_ID+a)}else{e=$("<span>").html(c).css({"float":"left",padding:"6px 12px","background-color":"#800080","border-radius":"20px","max-width":"45%","word-wrap":"break-word",display:"inline-block","word-break":"break-word",color:MESSAGE_TEXT_COLOR,"font-size":"16px"});g=$("<div>").css({margin:"4px 6px",width:"100%","float":"left"});g.attr("id",MESSAGES+a)}}}g.append(e);if(i!=null){g.append(i)}return g}function createConversationDiv(f,h,c){var e="";for(var g in f){e+=(f[g]);if(g!=f.length){e+="<br>"}}var b=$("<div>").attr({"class":"list-group-item list-group-item-action",id:CONVERSATIONS+h,"data-toggle":"tooltip","data-placement":"right","data-html":true,title:e}).css({width:"100%","text-overflow":"ellipsis","text-align":"left"});var a=$("<span>").html(e).css({"float":"left",display:"block"});var d=$("<span>").html(getNumberCommaFormatted(c)).css({display:"block","float":"right",color:"white",padding:"3px 3px","border-radius":"20px","background-color":CONVO_BACKGROUND_MESSAGE_COUNT});b.append(d);b.append(a);b.addClass(CLASS_POINTER);b.tooltip();return b}function createContactDiv(e,d,b){var c=$("<div>").attr({"class":"list-group-item list-group-item-action pointer "+CLASS_REMOVE_SHIFT_SELECT,id:CONTACTS+d,"data-toggle":"tooltip","data-placement":"right",title:b}).css({width:"100%"});c.on("click",function(i){if(!sendingNewMessage){if(!i.shiftKey){$("#slt_contact").children().removeClass(CLASS_SELECTED_CONTACT);$("#recipientList").empty()}var f=$(this);f.addClass(CLASS_SELECTED_CONTACT);var h=$("#new_message_container");if(!h.isShown){$("#new_message_container").show()}var g=$("#recipientList");if($("#"+RECIPIENT_LIST+d).length==0){g.append(createRecipientDiv(f.text().trim(),d))}else{$("#"+RECIPIENT_LIST+d).remove();f.removeClass(CLASS_SELECTED_CONTACT)}}});var a=$("<span>").html(e).attr("id",CONTACTS+d);c.append(a);c.tooltip();return c}function createRecipientDiv(b,d){var a=$("<ul>").attr({"class":"list-group-item "+CLASS_RECIPIENTS});a.attr("id",RECIPIENT_LIST+d);var c=$("<div>").attr({"class":"glyphicon glyphicon-remove "+CLASS_POINTER_NEW_MESSAGE,"float":"right"});c.on("click",function(){var f=$(this);f.parent().remove();var e=getNumbersFromString(f.parent().attr("id"));$("#"+CONTACTS+e).removeClass(CLASS_SELECTED_CONTACT)});a.append($("<div>").text(b).attr("float","left"));a.append(c);return a}function uiUpdateMessage(b,c){var a=$("#"+TEMP_MESSAGE_ID+b);if(a!=null){a.children("span").css("background-color",MESSAGE_BACKGROUND_COLOR_ME_SENT);a.attr(ID,MESSAGES+c)}else{}}function uiScrollTop(a){var c=$("#rm_messageArea");if(a==null||a<0){a=1000000}var b=a-c.offset().top;c.animate({scrollTop:b});return b}function uiConversationNewMesssage(b){var a=$("#"+CONVERSATIONS+b);a.css("background-color",CONVO_BACKGROUND_COLOR_MESSAGE_RECEIVED);var c=$("#slt_conversation");c.prepend(a)}function getTextFromParts(b){for(var a in b){if(b[a][CONTENT_TYPE]==CONTENT_TYPE_TEXT_PLAIN){return b[a][TEXT]}}return""}function hasDataFromParts(b){for(var a in b){if(b[a][CONTENT_TYPE].includes(CONTENT_TYPE_IMAGE)){return true}}return false}function getPhoneNumberFormat(b){var a="";var c=b.replace(/\D/g,"");if(c.length==10){a+="(";a+=c.substr(0,3);a+=")-";a+=c.substr(3,3);a+="-";a+=c.substr(6,4)}else{if(c.length==11){a+="+";a+=c.substr(0,1);a+="(";a+=c.substr(1,3);a+=")-";a+=c.substr(4,3);a+="-";a+=c.substr(7,4)}else{a=b}}return a}function getNumberCommaFormatted(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function getNumbersFromString(a){return a.replace(/\D/g,"")}function uiSendingNewMessage(a){sendingNewMessage=a;if(sendingNewMessage){$("#new_message_btns").hide();$("#sending_div").show();$("#new_message_textArea").prop("disabled",true);$(".new_message_pointer").hide()}else{$("#new_message_btns").show();$("#sending_div").hide();$("#new_message_textArea").prop("disabled",false);$("#new_message_cancelBtn").click();$(".new_message_pointer").show()}}function getRMAdjustedScrollTop(){var a=$("#rm_messageArea");return a.offset().top+a.scrollTop()}function convoDivExists(a){var b=$("#"+CONVO+a);if(b.length==0){return null}return b}function matchAddressFromConvo(c,b){var a=retrieveConversation(c)[RECIPIENTS];for(var e=0;e<a.length;e++){var f=a[e];var d=Object.keys(f)[0];if(b==f[PHONE_NUMBER]){return f[FULL_NAME]}}return"UNKNOWN"}$("#lsb_contactsTab").on("click",function(){$("#lsb_contactsTab").css({"background-color":"white","border-top":"solid black 1px","border-bottom":"solid transparent 1px"});$("#lsb_conversationsTab").css({"background-color":"#C77FFF","border-top":"solid black 1px","border-bottom":"solid black 1px"});$("#slt_contact").show();$("#slt_conversation").hide()});$("#lsb_conversationsTab").on("click",function(){$("#lsb_conversationsTab").css({"background-color":"white","border-top":"solid black 1px","border-bottom":"solid transparent 1px"});$("#lsb_contactsTab").css({"background-color":"#C77FFF","border-top":"solid black 1px","border-bottom":"solid black 1px"});$("#slt_conversation").show();$("#slt_contact").hide()});$("#lsb_searchBar").on("input",function(){$("#lsb_contactsTab").click();var a=$(this).first().val();if(a.length>0){var b=$("#slt_contact").children();$.each(b,function(c,e){var d=$(e);if(d.text().toUpperCase().indexOf(String(a).toUpperCase())>-1){d.show()}else{d.hide()}})}else{$("#slt_contact").children().show()}});$("#new_message_cancelBtn").on("click",function(){$("#new_message_container").hide();$("#slt_contact").children().removeClass(CLASS_SELECTED_CONTACT);$("#recipientList").empty();$("#new_message_textArea").val("")});$("#new_message_sendBtn").on("click",function(){var d=$("#recipientList").children();var g=$("#new_message_textArea").val();if(g.length>0&&d.length>0){var e=[];for(var c=0;c<d.length;c++){var a=retrieveContact(getNumbersFromString(d[c].id));var f=getNumbersFromString(a[PHONE_NUMBER]);e.push({number:f})}temp_convo_id_count++;storeConvoTempId(temp_convo_id_count);uiSendingNewMessage(true);var b=prepareMessages(g,"",e,temp_convo_id_count);webSocketCon.send(b)}});var messageInput=$("#rm_messageInput");messageInput.keydown(function(a){if(a.keyCode==16&&a.keyCode==13){return true}if(a.keyCode==13){$("#rm_sendBtn").click();return false}});messageInput.bind("DOMSubtreeModified",function(){$("#rm_charCount").html(getNumberCommaFormatted($(this).text().length))});var sent_message_temp_id=[];const ACTION="action",POST_CONTACTS="post_contacts",POST_CONVERSATIONS="post_conversations",POST_MESSAGES="post_messages",SENT_MESSAGES="sent_messages",SENT_MESSAGES_FAILED="sent_messages_failed",CONNECTED="connected",DISCONNECTED="disconnected",RECEIVED_MESSAGE="received_message",POST_DATA="post_data";var DATA="data";var android_connected=true;var active_json;var conversations;var contacts;var initial_connect_conversations=true;var DEFAULT_TITLE="RoofText";var MESSAGE_TITLE="RoofText";var titleInterval;var webOnMessage=function(r){active_json=JSON.parse(r.data);switch(active_json[ACTION]){case POST_CONTACTS:storeContacts(active_json);uiAddAllContacts();break;case POST_CONVERSATIONS:storeConversations(active_json);uiAddAllConversations();if(initial_connect_conversations){var n=retrieveConversations();var h=0;for(var q in n){var u=Object.keys(n[q])[0];var g=retrieveMessages(u);if(g==null){webSocketCon.send(getMessagesJSON(u,DEFAULT_GET_MESSAGES,-1,0))}else{webSocketCon.send(getMessagesJSON(u,DEFAULT_GET_MESSAGES_AFTER,g[0][Object.keys(g[0])][DATE_RECIEVED],1))}if(h>10){break}h++}initial_connect_conversations=false}break;case POST_MESSAGES:storeMessages(active_json);var d=active_json[THREAD_ID];var m=$("#convo_id").val();if(d==m){var k=convoDivExists(m);if(k==null){uiAddConversationMessages(m)}else{uiPrependMessage(d,active_json[d],m)}}if($("#"+CONVERSATIONS+d).length==0){webSocketCon.send(getConversations())}break;case SENT_MESSAGES:var f=retrieveConvoTempIdArr();for(var q in f){if(f[q]==active_json[TEMP_MESSAGE_ID]){f.splice(q,1);if(retrieveConversation(active_json[THREAD_ID])==null){webSocketCon.send(getConversations());webSocketCon.send(getMessagesJSON(active_json[THREAD_ID],DEFAULT_GET_MESSAGES,-1,1))}else{$("#slt_conversation").prepend($("#"+CONVERSATIONS+active_json[THREAD_ID]))}uiSendingNewMessage(false)}}f=retrieveMessageTempIdArr();for(var q in f){var c=JSON.parse(f[q]);if(c[TEMP_MESSAGE_ID]==active_json[TEMP_MESSAGE_ID]){uiUpdateMessage(active_json[TEMP_MESSAGE_ID],active_json[MESSAGE_ID]);f.splice(q,1)}}storeMessages(active_json);break;case SENT_MESSAGES_FAILED:break;case CONNECTED:android_connected=true;startUpCalls();$("#loading_label").css("background-color","#52CC82");$("#loading_text").html("Loading Content..");setTimeout(function(){$("#connect_waiting").modal("hide");$("#loading_label").css("background-color","#C77FFF");$("#loading_text").html("Waiting to connect...")},1500);break;case DISCONNECTED:android_connected=false;$("#connect_waiting").modal("show").focus();sendConnected();break;case RECEIVED_MESSAGE:var t=active_json;var b=$("#convo_id").val();var d=active_json[THREAD_ID];var k=convoDivExists(d);if(k!=null&&b==d){var j=active_json[d];for(var q in j){var u=Object.keys(j[q])[0];uiAppendMessage(j[q][u],u,k,b)}storeScrollTop(d,-1)}storeMessages(active_json);uiConversationNewMesssage(d);if(!retrieveConversation(b)){webSocketCon.send(getConversations())}if(!inFocus){MESSAGE_TITLE="You have a message.";if(titleInterval==null){titleInterval=setInterval(function(){var e=document.title;document.title=(e==DEFAULT_TITLE?MESSAGE_TITLE:DEFAULT_TITLE)},750)}}break;case POST_DATA:var o="fail";if(active_json[o]){$("#"+DATA+active_json[PART_ID]).removeClass().off("click").addClass("data_fail").html("Error loading. Currently only support images data.")}else{var a="image";var v=$("#"+DATA+active_json[PART_ID]+a);var s=$("#"+DATALOAD+active_json[PART_ID]);if(v.length==0){var l=$("<a>").attr("href","#").attr("class","imageTop");v=$('<img id="'+DATA+active_json[PART_ID]+a+'">').attr("src","data:image/png;base64,").css("clear","left").hide().addClass("img_area").css("float",s.css("float")).css("clear",s.css("clear"));l.append(v);l.insertAfter(s)}v.attr("src",v.attr("src")+active_json[DATA]);var p="finish";if(active_json[p]){v.show();s.remove()}}break}};var webOnOpen=function(){sendConnected()};var webOnErrorClose=function(){$("#connect_waiting").modal({backdrop:"static",show:true});setTimeout(function(){webSocketCon=start(URL)},7500)};var webSocketCon=start();function start(){ws=new WebSocket(URL);ws.onopen=webOnOpen;ws.onmessage=webOnMessage;ws.onclose=webOnErrorClose;return ws}$("#rm_sendBtn").click(function(){var h=$("#rm_messageInput");var c=$("#convo_id").val();if(h.html().length>0&&c!=""){var f=$("#rm_messageArea");var b=getNumbersFromString(f.children().last().attr("id"));var a=h.text();var d=prepareMessages(a,"",getNumbers(c),b);h.html("");webSocketCon.send(d);var e=JSON.parse(d);e[MESSAGE_TYPE]=TYPE_LOCAL_SEND;var g=$("#"+CONVO+c);uiAppendMessage(e,b,g,c);$("#slt_conversation").prepend($("#"+CONVERSATIONS+c).css("background-color",CONVO_BACKGROUND_COLOR_SELECTED));storeMessageTempIdArr(b,c,a);storeScrollTop(c,uiScrollTop(-1))}});$(document).on("click","a.imageTop",function(){$("#imageModalIMG").attr("src",$(this).find("img").attr("src"));$("#imageModal").modal("show")});$("#rm_messageArea").on("scroll",function(){if($(this).offset().top==0){var b=$("#convo_id").val();var a=retrieveMessages(b)[0];var c=a[Objects.key(a)[0]][DATE_RECIEVED];webSocketCon.send(getMessagesJSON(b,DEFAULT_GET_MESSAGES,c,0))}});var loadWait=true,loadWaitTime=1000;$("#rm_loadBtn").on("click",function(){if(loadWait){var a=$("#convo_id").val();if(a!==null&&a){var c=$("#rm_messageArea");var b=Object.keys(retrieveMessages(a)[0]);var d=retrieveMessages(a)[0][b][DATE_RECIEVED];webSocketCon.send(getMessagesJSON(a,DEFAULT_GET_MESSAGES,d,0))}loadWait=false;setTimeout(function(){loadWait=true},loadWaitTime)}});window.onload=function(){$("#slt_contact").hide();$("#connect_waiting").modal({backdrop:"static",show:true});$("#lsb_conversationsTab").click()};function startUpCalls(){webSocketCon.send(getContacts());webSocketCon.send(getConversations())}function sendConnected(){webSocketCon.send(JSON.stringify({action:CONNECTED}))}var inFocus=1;$(window).focus(function(){inFocus=1;if(titleInterval!=null){clearInterval(titleInterval);titleInterval=null}document.title=DEFAULT_TITLE});$(window).blur(function(){inFocus=0});