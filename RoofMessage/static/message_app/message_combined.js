var g="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)},m="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this;
function n(a,b){if(b){for(var c=m,d=a.split("."),e=0;e<d.length-1;e++){var f=d[e];f in c||(c[f]={});c=c[f]}d=d[d.length-1];e=c[d];f=b(e);f!=e&&null!=f&&g(c,d,{configurable:!0,writable:!0,value:f})}}
n("String.prototype.includes",function(a){return a?a:function(a,c){if(null==this)throw new TypeError("The 'this' value for String.prototype.includes must not be null or undefined");if(a instanceof RegExp)throw new TypeError("First argument to String.prototype.includes must not be a regular expression");return-1!==(this+"").indexOf(a,c||0)}});
n("Array.prototype.find",function(a){return a?a:function(a,c){var b;a:{b=this;b instanceof String&&(b=String(b));for(var e=b.length,f=0;f<e;f++){var h=b[f];if(a.call(c,h,f,b)){b=h;break a}}b=void 0}return b}});function p(){return JSON.stringify({action:"get_conversations"})}function q(a,b,c){return null==a?!1:JSON.stringify({action:"get_messages",thread_id:a,amount:15,offset:b,period:c})}function r(a,b,c){return JSON.stringify({action:"send_messages",body:a,data:"",temp_message_id:c,numbers:b})}
var t=0,u=[],v=[];
function w(){var a=x,b=sessionStorage.getItem("contacts"),a=a.contacts;null==b?b=a.sort(function(a,b){var c=0;a[Object.keys(a)[0]].full_name>b[Object.keys(b)[0]].full_name?c=1:a[Object.keys(a)[0]].full_name<b[Object.keys(b)[0]].full_name&&(c=-1);return c}):(b=JSON.parse(b),b=a.sort(function(a,b){var c=0;a[Object.keys(a)[0]].full_name>b[Object.keys(b)[0]].full_name?c=1:a[Object.keys(a)[0]].full_name<b[Object.keys(b)[0]].full_name&&(c=-1);return c}),b=b.filter(function(a,b,e){return!b||Object.keys(a)[0]!=
Object.keys(e[b-1])[0]}));sessionStorage.setItem("contacts",JSON.stringify(b))}
function aa(){var a=x.conversations,b=sessionStorage.getItem("conversations");if(null==b)b={};else{var c={},b=JSON.parse(b);$.j(b,function(a,b){var e=Object.keys(b)[0];c[e]=b[e]});b=c}for(var d in a){var e=Object.keys(a[d])[0];b[e]=a[d][e]}a=[];e=Object.keys(b);e=e.sort(function(a,c){return parseInt(b[c].date)-parseInt(b[a].date)});for(d in e){var f={},h=e[d];f[h]=b[h];a.push(f)}sessionStorage.setItem("conversations",JSON.stringify(a))}
function ba(){var a=sessionStorage.getItem("conversations");null==a?a={}:a=JSON.parse(a);return a}function z(a){var b=JSON.parse(sessionStorage.getItem("conversations")),c=null;$.j(b,function(b,e){Object.keys(e)[0]==a&&(c=e[a])});return c}
function A(){var a=x,b=a[B],c="messages"+b,d=sessionStorage.getItem(c);null==d?sessionStorage.setItem(c,JSON.stringify(a[b].sort(function(a,b){return a[Object.keys(a)[0]][C]-b[Object.keys(b)[0]][C]}))):(a=a[b],d=JSON.parse(d),d=a.concat(d).sort(function(a,b){return a[Object.keys(a)[0]][C]-b[Object.keys(b)[0]][C]}),d=d.filter(function(a,b,c){return!b||Object.keys(a)[0]!=Object.keys(c[b-1])[0]}),sessionStorage.setItem(c,JSON.stringify(d)))}
function D(a){return JSON.parse(sessionStorage.getItem("messages"+a))}function E(a,b){sessionStorage.setItem("scroll_top"+a,b)}function F(a,b,c){return JSON.stringify({action:"get_data",message_id:c,part_id:a,content_type:b})}function G(a,b){sessionStorage.setItem("loadingmore"+a,b)};var B="thread_id",C="date_recieved",ca=!1;
function da(){$("slt_conversation").empty();var a=ba();Object.keys(a);var b=$("#slt_conversation");$.j(a,function(a,d){for(var c=Object.keys(d)[0],f=d[c].recipients,h=[],l=[],k=0;k<f.length;k++)null!=f[k].full_name?h.push(f[k].full_name):h.push(H(f[k].phone_number)),l.push(H(f[k].phone_number));if(0==$("#conversations"+c).length){var y=ea(h,l,c);$.j(d[c].recipients,function(a,b){y.h("CONVO_CONTACT_ID"+b.contact_id)});$("#convo_id").i()==c&&y.b("background-color","#B697FA");y.g("click",function(){var a=
$("#convo_id"),b=a.i(),c=$(this),d=I(c.a("id"));d!=b&&(d!=b&&($("#conversations"+b).b("background-color",""),E(b,fa())),console.log(d+" "+c.a("id")),a.a("value",d),J(d)?K("t"==sessionStorage.getItem("loadingmore"+d)):(L.send(q(d,-1,0)),G(d,!0),K(!0)),setTimeout(function(){M(sessionStorage.getItem("scroll_top"+d))},300),$("#convo"+b).f());c.b("background-color","#B697FA");N(d)});b.append(y)}})}
function ga(){var a=$("#slt_contact"),b;b=sessionStorage.getItem("contacts");null==b?b={}:b=JSON.parse(b);for(var c in b){var d=Object.keys(b[c])[0],e=$("#contacts"+d);0==e.length&&(e=ha(b[c][d].full_name,d,H(b[c][d].phone_number)));a.append(e)}}
function J(a){var b=D(a);console.log("Adding messages from ["+a+"]");if(b){var c=$("#rt_messageArea"),d=$("#convo"+a).show();0==d.length&&(d=$('<div id="convo'+a+'">').show(),c.append(d));$.j(b,function(b,c){var e=Object.keys(c)[0],f=$("#messages"+e);0==f.length?O(c[e],e,d,a):d.append(f);for(var k in u)f=JSON.parse(u[k]),f.temp_message_id==e&&O(f.temp_message_id,e,d,a)})}else return console.log("Null value for conversation."),!1;return!0}
function ia(a,b,c){var d=P(a);a=$("#rt_messageArea");var e=-1;null==d?(d=$('<div id="convo'+c+'">'),$("#rt_messageArea").append(d)):e=a.scrollTop()-a.offset().top;$.j(b,function(a,b){$.j(b,function(a,b){0==$("#messages"+a).length&&d.l(Q(b,a,c))})});0<=e&&(e+=2*a.offset().top);M(e)}function O(a,b,c,d){a=Q(a,b,d);c.append(a)}
function Q(a,b,c){var d,e=!1,f="mms"==a.type,h=1<z(c).recipients.length;f?(d=ja(a.parts),e=ka(a.parts)):d=a.body;c=a.message_type;var l,k;if(1==c){c=$("<div>").b({margin:"4px 6px",width:"100%","float":"left"});e&&(k=$("<div>"),$.j(a.parts,function(a,b){if("text/plain"!=b.CONTENT_TYPE){var c=$("<span>").c("Click me to load image!").h("data").b({"float":"left",display:"block",clear:"left"}).a("id",R+b.id).a("val",b.CONTENT_TYPE);c.g("click",function(){var a=I($(this).a("id")),b=$(this).a("val"),c=I($(this).parent().parent().a("id"));
L.send(F(a,b,c));$(this).c("  Loading...");$(this).l($("<span>").h("glyphicon glyphicon-refresh spinning"));$(this).a("id","DATALOAD"+a)});k.append(c)}}));if(f&&""!=d||!f)l=$("<span>").c(d).b({"float":"left",padding:"6px 12px","background-color":"#52CC82","border-radius":"20px","max-width":"45%","word-wrap":"break-word",color:"white",display:"inline-block","word-break":"break-word",clear:"left","font-size":"16px"});h&&void 0!=l&&(l.c(l.c()+"<br>"),e=a.contact_id,a=$("<span>").c("- "+(void 0==e?H(a.address):
e)).b({"word-wrap":"break-word",display:"inline-block","word-break":"break-word","font-size":"13px"}),l.append(a));c.a("id","messages"+b)}else if(2==c){c=$("<div>").b({margin:"4px 6px",width:"100%","float":"right"});e&&(k=$("<div>"),$.j(a.parts,function(a,b){if("text/plain"!=b.CONTENT_TYPE){var c=$("<span>").c("Click me to load image!").h("data").b({"float":"right",display:"block",clear:"right"}).a("id",R+b.id).a("val",b.CONTENT_TYPE);c.g("click",function(){var a=I($(this).a("id")),b=$(this).a("val"),
c=I($(this).parent().parent().a("id"));L.send(F(a,b,c));$(this).c("  Loading...");$(this).l($("<span>").h("glyphicon glyphicon-refresh spinning"));$(this).a("id","DATALOAD"+a)});k.append(c)}}));if(f&&""!=d||!f)l=$("<span>").c(d).b({"float":"right",padding:"6px 12px","background-color":"#C77FFF","border-radius":"20px","max-width":"45%","word-wrap":"break-word",color:"white",display:"inline-block","word-break":"break-word",clear:"right","font-size":"16px"});c.a("id","messages"+b)}else 20==c?(l=$("<span>").c(d).b({"float":"right",
padding:"6px 12px","background-color":"#FF7FE5","border-radius":"20px","max-width":"45%","word-wrap":"break-word",display:"inline-block","word-break":"break-word",color:"white","font-size":"16px"}),c=$("<div>").b({margin:"4px 6px",width:"100%","float":"left"}),c.a("id","temp_message_id"+b)):(l=$("<span>").c(d).b({"float":"left",padding:"6px 12px","background-color":"#800080","border-radius":"20px","max-width":"45%","word-wrap":"break-word",display:"inline-block","word-break":"break-word",color:"white",
"font-size":"16px"}),c=$("<div>").b({margin:"4px 6px",width:"100%","float":"left"}),c.a("id","messages"+b));c.append(l);null!=k&&c.append(k);return c}
function ea(a,b,c){c=$("<div>").a({"class":"list-group-item list-group-item-action",id:"conversations"+c,"data-toggle":"tooltip","data-placement":"right","data-html":!0}).b({width:"100%","text-overflow":"ellipsis","text-align":"left"});var d=$("<div>").b({display:"block","float":"left"}),e="",f;for(f=0;f<a.length;f++)e+=b[f],d.append($("<span>").c(a[f]).b({"float":"left",display:"block"})),d.append("<br>");c.append(d);c.a("title",e);c.h("pointer");c.w({B:{show:2E3,f:100}});return c}
function ha(a,b,c){c=$("<div>").a({"class":"list-group-item list-group-item-action pointer remove_shift_select",id:"contacts"+b,"data-toggle":"tooltip","data-placement":"right",title:c}).b({width:"100%"});c.g("click",function(){var a=I($(this).a("id")),b=!0;0==$("#SEARCHNAME"+a).length&&(la($(this).text(),a),b=!1);$("#lsb_searchBarContacts").i("");var c=$("#slt_contact");c.children().show();c.f();$("#lsb_conversationsTab").click();b||(b=$("#slt_conversation"),1==$("#lsb_searchContactName").children().length?
(b.children().f(),$(".CONVO_CONTACT_ID"+a).show()):b.children(":visible").G(".CONVO_CONTACT_ID"+a).f())});a=$("<span>").c(a).a("id","contacts"+b);c.append(a);c.w();return c}function ma(){var a=x.message_id,b=$("#temp_message_id"+x.temp_message_id);null!=b?(b.children("span").b("background-color","#C77FFF"),b.a("ID","messages"+a),console.log("Updated message with id ["+a+"]")):console.log("Error updating color.")}
function M(a){var b=$("#rt_messageArea");if(null==a||0>a)a=1E6;a-=b.offset().top;b.A({scrollTop:a});return a}function na(a){a=$("#conversations"+a);a.b("background-color","#8EE6B7");$("#slt_conversation").l(a)}function ja(a){for(var b in a)if("text/plain"==a[b].CONTENT_TYPE)return a[b].TEXT;return""}function ka(a){for(var b in a)if(a[b].CONTENT_TYPE.includes("image"))return!0;return!1}
function H(a){var b="",c=a.replace(/\D/g,"");10==c.length?(b=b+"("+c.substr(0,3),b=b+")-"+c.substr(3,3),b=b+"-"+c.substr(6,4)):11==c.length?(b=b+"+"+c.substr(0,1),b=b+"("+c.substr(1,3),b=b+")-"+c.substr(4,3),b=b+"-"+c.substr(7,4)):b=a;return b}function I(a){return a.replace(/\D/g,"")}
function S(a){(ca=a)?($("#new_message_btns").f(),$("#sending_div").show(),$("#new_message_textArea").v("disabled",!0),$(".new_message_pointer").f()):($("#new_message_btns").show(),$("#sending_div").f(),$("#new_message_textArea").v("disabled",!1),$("#new_message_cancelBtn").click(),$(".new_message_pointer").show())}function fa(){var a=$("#rt_messageArea");return a.offset().top+a.scrollTop()}function P(a){a=$("#convo"+a);return 0==a.length?null:a}
function N(a){a=sessionStorage.getItem("loadmore"+a);null==a||null!=a&&"f"==a?($("#rt_loadBtn > span").c("Load More Messages"),$("#rt_loadBtn").o("loadBtnNM").h("loadBtnLM")):($("#rt_loadBtn > span").c("No More to Messages to Load"),$("#rt_loadBtn").o("loadBtnLM").h("loadBtnNM"))}
function la(a,b){var c=$("<p>").h("lsb_searchNameBubble").a("id","SEARCHNAME"+b);c.append($("<span>").c(a).b("vertical-align","-3px")).append($("<span>").c("&#10006;").h("nameSearchX").g("click",function(){$(this).parent().remove();var a=$("#lsb_searchContactName").children(),b=$("#slt_conversation"),c=I($(this).parent().text());if(0>=a.length)b.children().show();else{$(".CONVO_CONTACT_ID"+c).f();b="";for(c=0;c<a.length;c++)b+=".CONVO_CONTACT_ID"+I($(a[c]).a("id"));$(b).show()}}));1==$("#lsb_searchContactName").append(c).children().length%
2&&c.b("border-right-color","black")}function K(a){a?$("#loadBtnGlyp").show():$("#loadBtnGlyp").f()};$("#lsb_contactsTab").g("click",function(){$("#lsb_contactsTab").b({"background-color":"white","border-top":"solid black 1px","border-bottom":"solid transparent 1px"});$("#lsb_conversationsTab").b({"background-color":"#C77FFF","border-top":"solid black 1px","border-bottom":"solid black 1px"});$("#slt_contact").show();$("#slt_conversation").f()});
$("#lsb_conversationsTab").g("click",function(){$("#lsb_conversationsTab").b({"background-color":"white","border-top":"solid black 1px","border-bottom":"solid transparent 1px"});$("#lsb_contactsTab").b({"background-color":"#C77FFF","border-top":"solid black 1px","border-bottom":"solid black 1px"});$("#slt_conversation").show();$("#slt_contact").f()});
$("#lsb_searchBarContacts").g("input",function(){$("#lsb_contactsTab").click();var a=$(this).first().i();if(0<a.length){var b=$("#slt_contact").children();$.j(b,function(b,d){var c=$(d);-1<c.text().toUpperCase().indexOf(String(a).toUpperCase())?c.show():c.f()})}else $("#slt_contact").children().show()});$("#new_message_cancelBtn").g("click",function(){$("#new_message_container").f();$("#slt_contact").children().o("selected_contact");$("#recipientList").empty();$("#new_message_textArea").i("")});
$("#new_message_sendBtn").g("click",function(){var a=$("#recipientList").children(),b=$("#new_message_textArea").i();if(0<b.length&&0<a.length){for(var c=[],d=0;d<a.length;d++){var e;a:{e=I(a[d].id);for(var f=JSON.parse(sessionStorage.getItem("contacts")),h=0;h<f.length;h++){var l=f[h],k=Object.keys(l)[0];if(k==e){e=l[k];break a}}e=null}e=I(e.phone_number);c.push({number:e})}t++;v.push(t);S(!0);a=r(b,c,t);L.send(a)}});
$("#rt_messageInput").D(function(a){if(16==a.keyCode&&13==a.keyCode)return console.log("shift+enter"),!0;if(13==a.keyCode)return console.log("enter"),$("#rt_sendBtn").click(),!1});var R="data",T=!1,U=!1,x,V="RoofText",W;
function oa(a){x=JSON.parse(a.data);console.log(x.action);switch(x.action){case "post_contacts":w();ga();console.log("Added contacts.");break;case "post_conversations":aa();da();console.log("Added conversations.");break;case "post_messages":console.log(x[B]);A();a=x[B];"t"==x.end?sessionStorage.setItem("loadmore"+a,"t"):sessionStorage.setItem("loadmore"+a,"f");G(x[B],"f");var b=$("#convo_id").i();if(a==b){var c=P(b);null==c?J(b):ia(a,x[a],b);N(b);K(!1)}0==$("#conversations"+a).length&&L.send(p());
break;case "sent_messages":a=v;for(b in a)a[b]==x.temp_message_id&&(a.splice(b,1),null==z(x[B])?(L.send(p()),L.send(q(x[B],-1,1))):$("#slt_conversation").l($("#conversations"+x[B])),S(!1));a=u;for(b in a)JSON.parse(a[b]).temp_message_id==x.temp_message_id&&(ma(),a.splice(b,1));A();break;case "connected":0==T&&1==U&&(X(),T=U=!0);break;case "connected_reply":T=!0;console.log("Is android connected ["+T+"]");$("#loading_label").b("background-color","#52CC82");$("#loading_text").c("Loading Content..");
setTimeout(function(){$("#connect_waiting").m("hide");$("#loading_label").b("background-color","#C77FFF");$("#loading_text").c("Waiting to connect...")},1500);break;case "disconnected":U=T=!1;console.log("Is android connected ["+T+"]");$("#connect_waiting").m("show").focus();X();U=!0;break;case "received_message":var d=$("#convo_id").i();a=x[B];c=P(a);if(null!=c&&d==a){var e=x[a];for(b in e){var f=Object.keys(e[b])[0];O(e[b][f],f,c,d)}E(a,-1)}A();na(a);z(d)||L.send(p());Y||(V="You have a message.",
null==W&&(W=setInterval(function(){document.title="RoofText"==document.title?V:"RoofText"},750)));break;case "post_data":console.log("POST DATA! ["+x.id+"]"),x.fail?$("#"+R+x.part_id).o().H("click").h("data_fail").c("Error loading. Currently only support images data."):(b=$("#"+R+x.part_id+"image"),a=$("#DATALOAD"+x.part_id),0==b.length&&(c=$("<a>").a("href","#").a("class","imageTop"),b=$('<img id="'+R+x.part_id+'image">').a("src","data:image/png;base64,").b("clear","left").f().h("img_area").b("float",
a.b("float")).b("clear",a.b("clear")),c.append(b),c.C(a)),b.a("src",b.a("src")+x[R]),"t"==x.end&&(b.show(),a.remove()))}}function pa(){X();U=!0}function qa(){T=!1;$("#connect_waiting").m({s:"static",show:!0,u:!1});setTimeout(function(){console.log("Starting loop");L=Z()},7500)}var L=Z();function Z(){ws=new WebSocket(URL);ws.onopen=pa;ws.onmessage=oa;ws.onclose=qa;return ws}
$("#rt_sendBtn").click(function(){var a=$("#rt_messageInput"),b=$("#convo_id").i();if(0<a.c().length&&""!=b){var c=$("#rt_messageArea"),c=I(c.children().F().a("id"));console.log("Temp id message ["+c+"]");var d=a.text(),e=[],f=z(b).recipients,h;for(h in f)e.push({number:f[h].phone_number});h=r(d,e,c);a.c("");console.log(h);L.send(h);a=JSON.parse(h);a.message_type=20;h=$("#convo"+b);O(a,c,h,b);$("#slt_conversation").l($("#conversations"+b).b("background-color","#B697FA"));(a=u)||(a=[]);a.push(JSON.stringify({temp_message_id:c,
convo_id:b,body:d}));E(b,M(-1))}});$(document).g("click","a.imageTop",function(){$("#imageModalIMG").a("src",$(this).find("img").a("src"));$("#imageModal").m("show")});$("#rt_messageArea").g("scroll",function(){if(0==$(this).offset().top){var a=$("#convo_id").i(),b=D(a)[0],b=b[Objects.key(b)[0]][C];L.send(q(a,b,0))}});
$("#rt_loadBtn").g("click",function(){var a=$("#convo_id").i();if(null!==a&&a){var b=sessionStorage.getItem("loadingmore"+a);"Load More Messages"==$("#rt_loadBtn > span").text()&&"t"!=b&&($("#rt_messageArea"),b=Object.keys(D(a)[0]),b=D(a)[0][b][C],L.send(q(a,b,0)),G(a,"t"),K(!0))}});window.onload=function(){$("#slt_contact").f();$("#connect_waiting").m({s:"static",show:!0,u:!1});$("#lsb_conversationsTab").click()};
function X(){L.send(JSON.stringify({action:"connected"}));console.log("Sending Connected")}var Y=1;$(window).focus(function(){Y=1;null!=W&&(clearInterval(W),W=null);document.title="RoofText";console.log("In focus.")});$(window).blur(function(){Y=0;console.log("Out of focus.")});
