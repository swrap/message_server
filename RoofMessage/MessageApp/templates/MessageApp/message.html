{% load staticfiles %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="{% static "message_app/message.css" %}">
        <script src="{% static "message_app/JSONFunctions.js" %}"></script>
        <script src="{% static "message_app/uiFunctions.js" %}"></script>
    	<link rel="shortcut icon" href="{%  static 'message_app/favicon-32x32.png' %}">
        <scriptf type="text/javascript"></scriptf>
        <title>Rooftext</title>
    </head>
    <body>
        {% csrf_token %}
        <div id="bodyDiv"></div>
        <div id="master_container">
            <div id="leftSideBar">
                <div id=lsb_title>
                    <span style="font-weight: bold">ROOF</span>
                    <span style="margin-left:-10px;">text</span>
                </div>
                <div id="lsb_searchBarDiv">
                    <input id=lsb_searchBar type="text" placeholder="Search your contacts">
                </div>
                <div id="lsb_tabs">
                    <div id="lsb_contactsTab" class="lsb_toggleTab">Contacts</div>
                    <div id="lsb_conversationsTab" class="lsb_toggleTab">Conversations</div>
                </div>
                <div id="lsb_tabItems">
                    <div class="list-group" id="slt_contact">
                    </div>
                    <input type="hidden" id="contact_ids">
                    <div class="list-group" id="slt_conversation">
                    </div>
                    <input type="hidden" id="convo_id">
                </div>
                <div id="lsb_bottomBtns">
                    <div class="btn btn-outline-primary" id="lsb_settingsBtn" onclick="window.open('{% url 'MessageApp:settings' %}')">Settings</div>
                    <div class="btn btn-outline-primary" id="lsb_logoutBtn" onclick="location.href='{% url 'MessageApp:logout' %}'">Logout</div>
                </div>
            </div>
            <div id="new_message_container" hidden>
                <form>
                    <div class="form-group">
                        <label for="recipientInput">Recipients</label>
                        <ul class="list-group" id="recipientList"></ul>
                    </div>
                    <div class="form-group">
                        <label for="textArea">Message</label>
                        <textarea class="form-control" id="new_message_textArea" rows="3" style="
                            resize: vertical;
                        "></textarea>
                    </div>
                    <div id="new_message_btns" style="flex: 1;">
                        <div class="sendBtn" id="new_message_sendBtn" style="
                            border: solid 1px black;
                            padding-right: 5px;
                            float: left;
                        ">Send</div>
                        <div class="cancelBtn" id="new_message_cancelBtn" style="
                            border: solid 1px black;
                            float: right;
                        ">Cancel</div>
                    </div>
                    <div id="sending_div" hidden>
                        <span class="label label-default" id="sending_label" style="font-size: 16px; background-color: #8347B2;">
                            <span class="glyphicon glyphicon-refresh spinning"></span>
                            <span id="sending_text"> Attempting to send...</span>
                        </span>
                    </div>
                </form>
            </div>
            <div id="rightMessage">
                <div id="rm_topBar">{{ user.username}}</div>
                <div id="rm_loadBtn">Load More</div>
                <div id="rm_messageArea"></div>
                <div id="rm_inputsDiv">
                    <div id="rm_messageInput" contenteditable="true"></div>
                    <div id="rm_sendArea">
                        <div id="rm_sendBtn" class="sendBtn">Send</div>
                        <div id="rm_charCountArea">
                            <span>Char: <span id="rm_charCount">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="connect_waiting" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Waiting to connect</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            We are waiting for your phone to connect. Make sure your app is connected
                            to wifi and you are logged in through the app.
                            <br><br>
                            If you have not already, please download
                            the app <a href="https://www.rooftext.com" target="_blank">here</a>.
                            <br><br>
                        </p>
                        <span class="label label-default" id="loading_label" style="font-size: 16px;">
                            <span class="glyphicon glyphicon-refresh spinning"></span>
                            <span id="loading_text"> Waiting to connect...</span>
                        </span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-primary" onclick="location.href='{% url 'MessageApp:index' %}'">
                            Home Page
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                                id="button_settings"
                                onclick="window.open('{% url 'MessageApp:settings' %}')">
                            Settings
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="location.href='{% url 'MessageApp:logout' %}'">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-body">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <img id="imageModalIMG" src="" class="imagepreview" style="width: 100%;" >
              </div>
            </div>
          </div>
        </div>
    <script>
        // Listeners
        $('#lsb_contactsTab').on("click", function(){
            $('#lsb_contactsTab').css({"background-color":"white",
                                "border-top":"solid black 1px",
                                "border-bottom":"solid transparent 1px",});
            $('#lsb_conversationsTab').css({"background-color":"#C77FFF",
                              "border-top":"solid black 1px",
                              "border-bottom":"solid black 1px",});
            //displaying contacts
            $('#slt_contact').show();
            $('#slt_conversation').hide();
        });

        $('#lsb_conversationsTab').on("click", function(){
            $('#lsb_conversationsTab').css({"background-color":"white",
                              "border-top":"solid black 1px",
                              "border-bottom":"solid transparent 1px",});
            $('#lsb_contactsTab').css({"background-color":"#C77FFF",
                                "border-top":"solid black 1px",
                                "border-bottom":"solid black 1px",});
            $('#slt_conversation').show();
            $('#slt_contact').hide();
        });

        $('#lsb_searchBar').on("input", function () {
            $('#lsb_contactsTab').click();
            var searchText = $(this).first().val();
            if (searchText.length > 0) {
                var siblings = $('#slt_contact').children();
                $.each(siblings, function (index, value) {
                    var tempValue = $(value);
                    if (tempValue.text().toUpperCase().indexOf(String(searchText).toUpperCase()) > -1) {
                        tempValue.show();
                    } else {
                        tempValue.hide();
                    }
                });
            } else {
                $('#slt_contact').children().show();
            }
        });

        $("#new_message_cancelBtn").on("click", function () {
            $("#new_message_container").hide();
            $("#slt_contact").children().removeClass(CLASS_SELECTED_CONTACT);
            $("#recipientList").empty();
            $("#new_message_textArea").val("");
        });

        $("#new_message_sendBtn").on("click", function() {
            var children = $("#recipientList").children();
            var text = $('#new_message_textArea').val();
            if (text.length > 0 && children.length > 0) {
                var numbersJson = [];
                for (var i = 0; i < children.length; i++) {
                    var contact = retrieveContact(children[i].innerText.trim());
                    var number = getNumbersFromString(contact[PHONE_NUMBER]);
                    numbersJson.push({
                        "number": number
                    });
                }//TODO DOCUMENTATION
                //TODO HAVE TO REINVENT HOW TO SEND NEW MESSAGES

                temp_convo_id_count++;

                storeConvoTempId(temp_convo_id_count);

                //update sending message
                uiSendingNewMessage(true);

                var messageObjectString = prepareMessages(text,
                        "",
                        numbersJson,
                        temp_convo_id_count); //TODO redo temp id
                webSocketCon.send(messageObjectString);
            }
        });

        var messageInput = $('#rm_messageInput');
        messageInput.keydown(function(e) {
            if (e.keyCode == 16 && e.keyCode == 13) {
                console.log('shift+enter')
                return true;
            }
            if (e.keyCode == 13) {
                console.log('enter')
                $('#rm_sendBtn').click();
                return false;
            }
        });

        messageInput.bind("DOMSubtreeModified",function() {
            $('#rm_charCount').html(getNumberCommaFormatted($(this).text().length));
        });
        // ***************************************************


        var sent_message_temp_id = [];
        var webSocketCon = new WebSocket("ws://" + window.location.host + "/message_route/");
        const ACTION = "action",
                POST_CONTACTS = "post_contacts",
                POST_CONVERSATIONS = "post_conversations",
                POST_MESSAGES = "post_messages",
                SENT_MESSAGES = "sent_messages",
                SENT_MESSAGES_FAILED = "sent_messages_failed",
                CONNECTED = "connected",
                DISCONNECTED = "disconnected",
                RECEIVED_MESSAGE = "received_message",
                POST_DATA = "post_data";
        var DATA = "data";

        var android_connected = true;

        var active_json;
        var conversations;
        var contacts;
        var initial_connect_conversations = true;

        webSocketCon.onmessage = function(e) {
            active_json = JSON.parse(e.data);
            console.log(active_json[ACTION]);
            switch (active_json[ACTION]) {
                case POST_CONTACTS:
                        //contacts received, populate contacts section
                        storeContacts(active_json);
                        uiAddAllContacts();
                        console.log("Added contacts.");
                    break;
                case POST_CONVERSATIONS:
                        //conversations received, populate conversations section
                        storeConversations(active_json);
                        uiAddAllConversations();
                        //initial connect ask for messages from convo
                        if (initial_connect_conversations) {
                            var convos = retrieveConversations();
                            var count = 0;
                            for (var i in convos) {
                                var key = Object.keys(convos[i])[0];
                                console.log("Sending for messages [" + key + "]");
                                webSocketCon.send(getMessagesJSON(key,
                                DEFAULT_GET_MESSAGES,
                                -1 /*offset*/,
                                0 /*before*/));

                                if (count > 10) {
                                    break;
                                }
                                count++;
                            }
                            initial_connect_conversations = false;
                        }
                        console.log("Added conversations.");
                    break;
                case POST_MESSAGES:
                        console.log(active_json[THREAD_ID]);
                        //messages received, populate conversations section
                        storeMessages(active_json);
                        var jsonConvoId = active_json[THREAD_ID];
                        var convoIdVal = $('#convo_id').val();
                        if (jsonConvoId == convoIdVal) {
                            //convoDiv empty for specific convo then addAllMessages
                            var convoDiv = convoDivExists(convoIdVal);
                            if (convoDiv == null) {
                                //problems if click on convo before loaded
                                //should append in this case
                                //was making conversation appear backwards
                                uiAddConversationMessages(convoIdVal)
                            } else {
                                uiPrependMessage(jsonConvoId,active_json[jsonConvoId],convoIdVal);
                            }
                        }
                    break;
                case SENT_MESSAGES:
                        //message successfully sent, ??Change color of message bubble???

                        //UPDATING CONVO ID FOR NEW_MESSAGE_SENT (USED FOR CONVOS THAT DO NOT EXIST)
                        var tempIdArr = retrieveConvoTempIdArr();
                        for (var i in tempIdArr) {
                            if (tempIdArr[i] == active_json[TEMP_MESSAGE_ID]) { //TODO RENAME TEMP_MESSAGE_ID to TEMP_ID
                                tempIdArr.splice(i,1);
                                //get convo if not already have
                                if (retrieveConversation(active_json[THREAD_ID]) == null) {
                                    webSocketCon.send(getConversations()); //TODO WAISTEFUL, MAKE JSON TO REQUEST ONE CONVO
                                    webSocketCon.send(getMessagesJSON(active_json[THREAD_ID],
                                            DEFAULT_GET_MESSAGES,
                                            -1, /*offset*/
                                            1 /*period*/));
                                } else {
                                    $('#slt_conversation').prepend($('#' + CONVERSATIONS + active_json[THREAD_ID]));
                                }

                                //update sending msg
                                uiSendingNewMessage(false);
                            }
                        }

                        //UPDATING TEMP ID FOR MESSAGE SENT
                        tempIdArr = retrieveMessageTempIdArr();
                        for (var i in tempIdArr) {
                            var jsonTemp = JSON.parse(tempIdArr[i]);
                            if (jsonTemp[TEMP_MESSAGE_ID] == active_json[TEMP_MESSAGE_ID]) {
                                uiUpdateMessage(active_json[TEMP_MESSAGE_ID],
                                    active_json[MESSAGE_ID]);
                                tempIdArr.splice(i,1);
                            }
                        }

                        storeMessages(active_json);
                    break;
                case SENT_MESSAGES_FAILED:
                        //message failed to send, ??Change color of message bubble???
                    break;
                case CONNECTED:
                        //android connected
                        android_connected = true;
                        console.log("Is android connected [" + android_connected + "]");
                        startUpCalls();
                        $('#loading_label').css("background-color", "#52CC82");
                        $('#loading_text').html("Loading Content..");
                        setTimeout(function () {
                            $('#connect_waiting').modal('hide');
                            $('#loading_label').css("background-color", "#C77FFF");
                        $('#loading_text').html("Waiting to connect...");
                        }, 1500);
                    break;
                case DISCONNECTED:
                        //android disconnected
                        android_connected = false;
                        console.log("Is android connected [" + android_connected + "]");
                        $('#connect_waiting').modal('show').focus();
                        //TODO fix backend to not send disconnect on wifi reconnect disconnect
                        sendConnected();
                    break;
                case RECEIVED_MESSAGE:
                        //received a message check to add to ui
                        var tempJson = active_json;
                        var convo_id_val = $('#convo_id').val();
                        var jsonConvoId = active_json[THREAD_ID];

                        var convoDiv = convoDivExists(jsonConvoId);
                        if (convoDiv != null) {
                            //if the convoDiv exists update date the div by appending the messages
                            var jsonObject = active_json[jsonConvoId];
                            for (var i in jsonObject) {
                                var key = Object.keys(jsonObject[i])[0];
                                uiAppendMessage(jsonObject[i][key],key,convoDiv);
                            }
                            storeScrollTop(jsonConvoId, -1);
                        }

                        storeMessages(active_json);
                        //update the conversation color to state that it has a new message
                        uiConversationNewMesssage(jsonConvoId);
                        //if conversation is not here then load it
                        if (!retrieveConversation(convo_id_val)) {
                            //TODO will need to change to send a new convo and push to top of queue and change color
                            //NEED TO LOAD SPECIFIC CONVERSATIONS
                        }
                    break;
                case POST_DATA:
                        //received data call
                        console.log("POST DATA! [" + active_json[MESSAGE_ID]);

                        //storeData(active_json[MESSAGE_ID], active_json[DATA]);

                        //attempts to find image
                        var FAIL = "fail";
                        if (active_json[FAIL]) {
                            $('#' + DATA + active_json[MESSAGE_ID])
                                    .removeClass()
                                    .off('click')
                                    .addClass("data_fail")
                                    .html('Error loading. Currently only support images data.');
                        } else {
                            var IMG = "image";
                            var img = $('#'+DATA + active_json[MESSAGE_ID] + IMG);

                            if(img.length == 0) {
                                //if image is not found then create new image object
                                var tempH = $('<a>')
                                        .attr("href","#")
                                        .attr("class","imageTop");
                                img = $('<img id="' + DATA + active_json[MESSAGE_ID] + IMG + '">')
                                        .attr('src','data:image/png;base64,')
                                        .hide()
                                        .addClass("img_area")
                                        .css("float",$('#' + DATA + active_json[MESSAGE_ID]).css("float"))
                                        .css("clear",$('#' + DATA + active_json[MESSAGE_ID]).css("clear"));
                                tempH.append(img);
                                $('#' + MESSAGES + active_json[MESSAGE_ID]).append(tempH);
                            }
                            //append to img
                            img.attr('src', img.attr('src') + active_json[DATA]);

                            var FINISH = "finish";
                            if(active_json[FINISH]){
                                //if it is the last section then notify gui to update
                                img.show()
                                $('#' + DATA + active_json[MESSAGE_ID]).remove();
                            }
                        }
                    break;
            }
        };

        webSocketCon.onopen = function() {
            sendConnected();
        };

        webSocketCon.onclose = function() {
            $('#connect_waiting').modal({
                backdrop: 'static',
                show:true
            });
            window.timerID=setInterval(function(){start("wss://" + window.location.host + "/message_route/")}, 3000);
        };

        $('#rm_sendBtn').click(function(){
            var rm_message_input = $('#rm_messageInput');
            var convo_id_val = $('#convo_id').val();
            if (rm_message_input.html().length > 0 && convo_id_val != "") {
                var rmArea = $('#rm_messageArea');
                var temp_id = getNumbersFromString(rmArea.children().last().attr('id'));
                console.log("Temp id message [" + temp_id + "]");
                var body = rm_message_input.text();
                var messageObjectString = prepareMessages(body, "", getNumbers(convo_id_val), temp_id);
                rm_message_input.html("");
                console.log(messageObjectString);
                //append to ui
                webSocketCon.send(messageObjectString);
                var messageObject = JSON.parse(messageObjectString)
                messageObject[MESSAGE_TYPE] = TYPE_LOCAL_SEND;
                var convoDiv = $('#' + CONVO + convo_id_val);
                uiAppendMessage(messageObject, temp_id, convoDiv);
                $('#' + CONVERSATIONS + convo_id_val).css("background-color",CONVO_BACKGROUND_COLOR_SELECTED);
                //store for future reference
                storeMessageTempIdArr(temp_id, convo_id_val, body);
                storeScrollTop(convo_id_val,uiScrollTop(-1));
            }
        });

        $(document).on("click", "a.imageTop",function(){
            $('#imageModalIMG').attr('src', $(this).find('img').attr('src'));
            $('#imageModal').modal("show");
        });

        //scrolling query more messages
        $('#rm_messageArea').on("scroll",function(){
            if($(this).offset().top == 0) {
                var convo_id = $('#convo_id').val();
                var messageZero = retrieveMessages(convo_id)[0];
                var offset = messageZero[Objects.key(messageZero)[0]][DATE_RECIEVED];
                webSocketCon.send(getMessagesJSON(convo_id,DEFAULT_GET_MESSAGES,offset,0/*before*/));
            }
        });

        var loadWait = true,
                loadWaitTime = 1000;

        $('#rm_loadBtn').on("click", function () {
            if (loadWait) {
                var convoIdVal = $('#convo_id').val();
                if (convoIdVal !== null && convoIdVal) {
                    var rmArea = $('#rm_messageArea');
                    var key = Object.keys(retrieveMessages(convoIdVal)[0]);
                    var offset = retrieveMessages(convoIdVal)[0][key][DATE_RECIEVED];
                    webSocketCon.send(getMessagesJSON(convoIdVal,DEFAULT_GET_MESSAGES,offset,0/*before*/));
                }
                loadWait = false;
                setTimeout(function() { loadWait = true }, loadWaitTime);
            }
        });

        window.onload = function () {
            $('#slt_contact').hide();

            $('#connect_waiting').modal({
                backdrop: 'static',
                show:true
            });

            $('#lsb_conversationsTab').click();
        };

        function startUpCalls() {
            console.log(ACTION);
            //loads contacts
            webSocketCon.send(getContacts());
            //loads top conversations
            webSocketCon.send(getConversations());
            console.log("Sent for all");
        }

        function sendConnected() {
            webSocketCon.send(JSON.stringify( {
                "action" : CONNECTED
            }));
        }
    </script>
    </body>
</html>
