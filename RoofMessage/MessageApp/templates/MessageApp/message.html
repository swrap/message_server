{% load staticfiles %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="{% static "message_app/message.css" %}">
        <script src="{% static "message_app/JSONFunctions.js" %}"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
        <title>ROOFmessage</title>
        <script type="text/javascript"></script>
    </head>
    <body>
        {% csrf_token %}
        <div id="master_container">
            <div id="leftSideBar">
                <div id=lsb_title>
                    <span style="font-weight: bold">ROOF</span>
                    <span style="margin-left:-10px; color:pink">message</span>
                </div>
                <div id="lsb_searchBarDiv">
                    <input id=lsb_searchBar type="text" placeholder="Search your contacts">
                </div>
                <div id="lsb_tabs">
                    <div id=lsb_contactsTab class=lsb_toggleTab style="background-color:#f66;
                                                                border-top:solid #f66 1px;
                                                                border-right:solid black 1px;
                                                                border-bottom:solid black 1px;">Contacts</div>
                    <div id=lsb_messagesTab class=lsb_toggleTab style="border-top:solid black 1px;
                                                                border-bottom:solid red 1px;">Messages</div>
                </div>
                <div id="lsb_tabItems">
                    <!--<select id="scroll_data" size="41" multiple style="width:100%;"></select>-->
                </div>
                <div id="lsb_bottomBtns">
                    <div id="lsb_settingsBtn" onclick="{% url 'MessageApp:settings' %}" target="_blank">Settings</div>
                    <div id="lsb_logoutBtn" onclick="{% url 'MessageApp:logout' %}">Logout</div>
                </div>
            </div>
            <div id="rightMessage">
                <div id="rm_topBar">Jesse Saran</div>
                <div id="rm_messageArea"></div>
                <div id="rm_inputsDiv">
                    <div id="rm_messageInputDiv">
                        <div id="rm_messageInput" contenteditable="true"></div>
                    </div>
                    <div id="rm_sendBtn">Send</div>
                </div>
            </div>
        </div>
    <script>
        // Listeners
        $('#lsb_contactsTab').on("click", function(){
            $('#lsb_contactsTab').css({"background-color":"red",
                                "border-top":"solid black 1px",
                                "border-bottom":"solid red 1px",});
            $('#lsb_messagesTab').css({"background-color":"#f66",
                              "border-top":"solid #f66 1px",
                              "border-bottom":"solid black 1px",});
        });

        $('#lsb_messagesTab').on("click", function(){
            $('#lsb_messagesTab').css({"background-color":"red",
                              "border-top":"solid black 1px",
                              "border-bottom":"solid red 1px",});
            $('#lsb_contactsTab').css({"background-color":"#f66",
                                "border-top":"solid #f66 1px",
                                "border-bottom":"solid black 1px",});
        });
        $('#rm_messageInput').keydown(function(e) {
            if (e.keyCode == 16 && e.keyCode == 13){
                console.log('shift+enter')
                return true;
            }
            if(e.keyCode == 13) {
                console.log('enter')
                $('#rm_sendBtn').click();
                return false;
            }
        });
        // ***************************************************

        // ***************************************************
        var socket = new WebSocket("ws://" + window.location.host + "/message_route/");
        const ACTION = "action",
                POST_CONTACTS = "post_contacts",
                POST_CONVERSATIONS = "post_conversations",
                POST_MESSAGES = "post_messages",
                SENT_MESSAGES = "sent_messages",
                SENT_MESSAGES_FAILED = "sent_messages_failed";

        var active_json;
        socket.onmessage = function(e) {
            active_json = JSON.parse(e.data);
            console.log(active_json[ACTION]);
            switch (active_json[ACTION]) {
                case POST_CONTACTS:
                        //contacts received, populate contacts section
                        storeContacts(active_json);
                    break;
                case POST_CONVERSATIONS:
                        //conversations received, populate conversations section
                        storeConversations(active_json);
                    break;
                case POST_MESSAGES:
                        //messages received, populate conversations section
                    break;
                case SENT_MESSAGES:
                        //message successfully sent, ??Change color of message bubble???
                    break;
                case SENT_MESSAGES_FAILED:
                        //message failed to send, ??Change color of message bubble???
                    break;
            }

{#            var messageRowDiv = $('<div>').css({#}
{#                "padding":"8px 6px"#}
{#            });#}
{#            var messageText = e.data;#}
{#            var messageTextSpan = $('<span>').html(messageText).css({#}
{#                "padding":"6px 12px",#}
{#                "background-color":"#ffcdcd",#}
{#                "border-radius":"20px",#}
{#            });#}
{#            messageRowDiv.append(messageTextSpan);#}
{#            $('#rm_messageArea').append(messageRowDiv);#}
        };
        socket.onopen = function() {
            socket.send(getContacts());
            socket.send(getConversations());
        };
        socket.onclose = function() {
            socket.send("I just left :(");
            socket = new WebSocket("ws://" + window.location.host + "/message_route/");
        };

        $('#rm_sendBtn').click(function(){
            var messageRowDiv = $('<div>').css({
                "height":"30px",
                "margin":"4px 6px"
            });
            var messageText = $('#rm_messageInput').text();
            var messageTextSpan = $('<span>').html(messageText).css({
                "float":"right",
                "padding":"6px 12px",
                "background-color":"#CDF0FF",
                "border-radius":"20px",
            });
            if(messageText.length > 0) {
                socket.send(messageText);
                messageRowDiv.append(messageTextSpan);
                $('#rm_messageArea').append(messageRowDiv);
                $('#rm_messageInput').html("");
            }
        });

        window.onbeforeunload = function (){
        };

    </script>
    </body>
</html>