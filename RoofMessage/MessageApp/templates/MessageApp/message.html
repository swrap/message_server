{% load staticfiles %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="{% static "message_app/message.css" %}">
        <script src="{% static "message_app/JSONFunctions.js" %}"></script>
        <script src="{% static "message_app/ui_functions.js" %}"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
        <title>ROOFtext</title>
        <script type="text/javascript"></script>
    </head>
    <body>
        {% csrf_token %}
        <div id="master_container">
            <div id="leftSideBar">
                <div id=lsb_title>
                    <span style="font-weight: bold">ROOF</span>
                    <span style="margin-left:-10px; color:pink">text</span>
                </div>
                <div id="lsb_searchBarDiv">
                    <input id=lsb_searchBar type="text" placeholder="Search your contacts">
                </div>
                <div id="lsb_tabs">
                    <div id=lsb_contactsTab class=lsb_toggleTab style="background-color:#f66;
                                                                border-top:solid #f66 1px;
                                                                border-right:solid black 1px;
                                                                border-bottom:solid black 1px;">Contacts</div>
                    <div id=lsb_messagesTab class=lsb_toggleTab style="border-top:solid black 1px;
                                                                border-bottom:solid red 1px;">Conversations</div>
                </div>
                <div id="lsb_tabItems">
                    <select class="scroll_data" id="slt_contact" size="41" multiple style="">
                    </select>
                    <select class="scroll_data" id="slt_conversation" size="41" multiple style="">
                    </select>
                    <input type="hidden" id="convo_id">
                </div>
                <div id="lsb_bottomBtns">
                    <div id="lsb_settingsBtn" onclick="window.open('{% url 'MessageApp:settings' %}')">Settings</div>
                    <div id="lsb_logoutBtn" onclick="location.href='{% url 'MessageApp:logout' %}'">Logout</div>
                </div>
            </div>
            <div id="rightMessage">
                <div id="rm_topBar">Jesse Saran</div>
                <div id="rm_messageArea"></div>
                <div id="rm_inputsDiv">
                    <div id="rm_messageInputDiv">
                        <div id="rm_messageInput" contenteditable="true"></div>
                    </div>
                    <div id="rm_sendBtn">Send</div>
                </div>
            </div>
        </div>
    <script>
        // Listeners
        $('#lsb_contactsTab').on("click", function(){
            $('#lsb_contactsTab').css({"background-color":"red",
                                "border-top":"solid black 1px",
                                "border-bottom":"solid red 1px",});
            $('#lsb_messagesTab').css({"background-color":"#f66",
                              "border-top":"solid #f66 1px",
                              "border-bottom":"solid black 1px",});
            //displaying contacts
            $('#slt_contact').show();
            $('#slt_conversation').hide();
        });

        $('#lsb_messagesTab').on("click", function(){
            $('#lsb_messagesTab').css({"background-color":"red",
                              "border-top":"solid black 1px",
                              "border-bottom":"solid red 1px",});
            $('#lsb_contactsTab').css({"background-color":"#f66",
                                "border-top":"solid #f66 1px",
                                "border-bottom":"solid black 1px",});
            $('#slt_conversation').show();
            $('#slt_contact').hide();

        });
        $('#rm_messageInput').keydown(function(e) {
            if (e.keyCode == 16 && e.keyCode == 13){
                console.log('shift+enter')
                return true;
            }
            if(e.keyCode == 13) {
                console.log('enter')
                $('#rm_sendBtn').click();
                return false;
            }
        });
        $('#slt_conversation').on("click", function () {
            var convo_id = $('#convo_id');
            var convo_id_val = convo_id.val();
            var selectedOption = $(this).find(":selected");
            var match =  (/(.*?)([0-9]+)/g).exec(selectedOption.val());
            var id = match[2];
            if (id != convo_id_val) {
                storeScrollTop(convo_id_val, $('#rm_messageArea').scrollTop());
            }
            console.log(id + " " + selectedOption.val());
            convo_id.attr("value",id);
            if (!uiAddConversationMessages(id)) {
                webSocketCon.send(getMessagesJSON(id,DEFAULT_GET_MESSAGES,0));
            }
            uiScrollTop(retrieveScrollTop(id));
        });
        // ***************************************************

        // ***************************************************


        var sent_message_temp_id = [];
        var webSocketCon = new WebSocket("ws://" + window.location.host + "/message_route/");
        const ACTION = "action",
                POST_CONTACTS = "post_contacts",
                POST_CONVERSATIONS = "post_conversations",
                POST_MESSAGES = "post_messages",
                SENT_MESSAGES = "sent_messages",
                SENT_MESSAGES_FAILED = "sent_messages_failed",
                CONNECTED = "connected",
                DISCONNECTED = "disconnected",
                RECEIVED_MESSAGE = "received_message";

        var android_connected = true;

        var active_json;
        var conversations;
        var contacts;
        var initial_connect_conversations = true;
        webSocketCon.onmessage = function(e) {
            active_json = JSON.parse(e.data);
            console.log(active_json[ACTION]);
            switch (active_json[ACTION]) {
                case POST_CONTACTS:
                        //contacts received, populate contacts section
                        storeContacts(active_json);
                        uiAddAllContacts();
                        console.log("Added contacts.");
                    break;
                case POST_CONVERSATIONS:
                        //conversations received, populate conversations section
                        storeConversations(active_json);
                        uiAddAllConversations();
                        //initial connect ask for messages from convo
                        if (initial_connect_conversations) {
                            var convos = retrieveConversations();
                            for (var i in convos) {
                                var key = Object.keys(convos[i])[0];
                                console.log("Sending for messages [" + key + "]");
                                webSocketCon.send(getMessagesJSON(key,
                                DEFAULT_GET_MESSAGES,
                                0 /*offset*/));
                            }
                            initial_connect_conversations = false;
                        }
                        console.log("Added conversations.");
                    break;
                case POST_MESSAGES:
                        //messages received, populate conversations section
                        storeMessages(active_json);
                        var jsonConvoId = active_json[THREAD_ID];
                        if (jsonConvoId == $('#convo_id').val()) {
                            uiPrependMessage(jsonConvoId,active_json[jsonConvoId]);
                        }
                    break;
                case SENT_MESSAGES:
                        //message successfully sent, ??Change color of message bubble???
                        var tempIdArr = retrieveTempIdArr();
                        for (var i in tempIdArr) {
                            var jsonTemp = JSON.parse(tempIdArr[i]);
                            if (jsonTemp[TEMP_MESSAGE_ID] == active_json[TEMP_MESSAGE_ID]) {
                                uiUpdateMessage(active_json[TEMP_MESSAGE_ID],
                                    active_json[MESSAGE_ID]);
                                storeTempIdArr(tempIdArr.splice(i,1));
                            }
                        }
                        storeMessages(active_json);
                    break;
                case SENT_MESSAGES_FAILED:
                        //message failed to send, ??Change color of message bubble???
                    break;
                case CONNECTED:
                        //android connected
                        android_connected = true;
                        console.log("Is android connected [" + android_connected + "]");
                    break;
                case DISCONNECTED:
                        //android disconnected
                        android_connected = false;
                        console.log("Is android connected [" + android_connected + "]");
                    break;
                case RECEIVED_MESSAGE:
                        //received a message check to add to ui
                        var tempJson = active_json;
                        var convo_id_val = $('#convo_id').val();
                        var jsonConvoId = active_json[THREAD_ID];
                        if (convo_id_val !== null && jsonConvoId == convo_id_val) {
                            var jsonObject = active_json[jsonConvoId];
                            for (var i in jsonObject) {
                                var key = Object.keys(jsonObject[i])[0];
                                uiAppendMessage(jsonObject[i][key][BODY],
                                    key,
                                    jsonObject[i][key][MESSAGE_TYPE]
                                );
                            }
                            storeScrollTop(uiScrollTop(-1));
                        }
                        storeMessages(active_json);
                    break;
            }
        };
        webSocketCon.onopen = function() {
            startUpCalls();
        };
        webSocketCon.onclose = function() {
            webSocketCon = new WebSocket("ws://" + window.location.host + "/message_route/");
        };

        $('#rm_sendBtn').click(function(){
            var rm_message_input = $('#rm_messageInput');
            var convo_id_val = $('#convo_id').val();
            if (rm_message_input.html().length > 0 && convo_id_val != "") {
                var rmArea = $('#rm_messageArea');
                var temp_id = parseInt(String(rmArea.children().last().attr('id')).match(/\d+/));
                console.log("Temp id message [" + temp_id + "]");
                var body = rm_message_input.text();
                var messageObject = JSON.stringify(
                    {
                        "action":"send_messages",
                        "body":body,
                        "data":"",
                        "temp_message_id":temp_id,
                        "numbers": getNumbers(convo_id_val)
                    }
                );
                rm_message_input.html("");
                console.log(messageObject);
                //append to ui
                uiAppendMessage(body, temp_id, TYPE_LOCAL_SEND);
                //store for future reference
                storeTempId(temp_id, convo_id_val, body);
                uiScrollTop(-1);
                webSocketCon.send( messageObject );
            }
        });

        //scrolling query more messages
        $('#rm_messageArea').on("scroll",function(){
            if($(this).scrollTop() == 0) {
                var offset = $('#rm_messageArea').children().size();
                webSocketCon.send(getMessagesJSON($('#convo_id').val(),DEFAULT_GET_MESSAGES,offset));
            }
        });

        window.onload = function () {
            $('#slt_contact').hide();
        };

        function startUpCalls() {
            console.log(ACTION);
            webSocketCon.send(JSON.stringify( {
                "action" : CONNECTED
            }));
            //loads contacts
            webSocketCon.send(getContacts());
            //loads top conversations
            webSocketCon.send(getConversations());
            console.log("Sent for all");
        }

    </script>
    </body>
</html>